(function(window,undefined){if(typeof exports!=="undefined"){rad=exports}else{rad=window.rad={}}var rad={};window.rad=rad;rad.core={};rad.core.debug=true;rad.getPackage=function(ns){var sp=String(ns).split(".");var current=rad;for(var i=0;i<sp.length;i++){if(current[sp[i]]===undefined){current[sp[i]]={}}current=current[sp[i]]}return current};rad.noConflicts=function(scope){scope.rad=window.rad;delete window.rad};(function(){var initializing=false,fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(prop){var _super=this.prototype;initializing=true;var prototype=new this();initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}})(name,prop[name]):prop[name]}function Class(){if(!initializing&&this.init){this.init.apply(this,arguments)}}Class.prototype=prototype;Class.constructor=Class;Class.extend=arguments.callee;return Class}})();var pkg=rad.getPackage("core");pkg.RadClass=Class.extend({_className:"RadClass",name:"RadClass",_uniqueId:null,_debug:false,init:function(){this._uniqueId=Math.round(Math.random()*10000)+new Date().getTime()},log:function(){if(rad.core.debug&&this._debug){if(console!==undefined&&console.log){arguments[0]=this.name+":"+arguments[0];return console.log.apply(console,arguments)}}},error:function(){if(rad.core.debug&&this._debug){if(console!==undefined&&console.error!==undefined){arguments[0]=this.name+":"+arguments[0];return console.error.apply(console,arguments)}}},destroy:function(){for(var i in this){delete this[i]}}});var pkg=rad.getPackage("event");pkg.Event=rad.core.RadClass.extend({_className:"Event",name:"Event",_type:"event",_stopped:false,init:function(type){if(typeof type=="string"){this._type=type;this._ns=this.name+"."+this._type}else{this._ns=this.name}this._super()},stopPropagation:function(){this._stopped=true},isPropagationStopped:function(){return this._stopped}});var pkg=rad.getPackage("event");pkg.EventDispatcher=rad.core.RadClass.extend({_className:"EventDispatcher",_eventListeners:{},_debug:true,init:function(){this._super();this._eventListeners={}},addListener:function(eventName,handler,scope){var names=this._parseEventName(eventName);var n;for(var i=0;i<names.length;i++){n=names[i];if(this._eventListeners[n]==undefined){this._eventListeners[n]=[]}this._eventListeners[n].push({scope:scope,handler:handler})}return this},removeListener:function(eventName,handler,scope){if(eventName===null||eventName===undefined){if(handler===null||handler===undefined){if(scope!==null&&scope!==undefined){this.log("scope is not null, removing all listeners for scope:",scope,this._eventListeners);for(var i in this._eventListeners){for(var a=this._eventListeners[i].length-1;a>=0;a--){this.log("removing:",i,a,this._eventListeners[i][a].scope);this.removeListener(i,this._eventListeners[i][a].handler,this._eventListeners[i][a].scope)}}return this}else{return this}}}var names=this._parseEventName(eventName);var n;for(var i=0;i<names.length;i++){n=eventName[i];if(n!==null&&n!==undefined){var el=this._eventListeners[n];if(el!==undefined){for(var i=0;i<el.length;i++){if(el[i].scope==scope&&el[i].handler==handler){el.splice(i,1);break}}}}}return this},_dispatch:function(event){if(event instanceof rad.event.Event){var eName=event._ns;if(this._eventListeners[eName]!==undefined){var el=this._eventListeners[eName];for(var i=0;i<el.length;i++){if(!event.isPropagationStopped()){var item=el[i];var scope=(item.scope===undefined||item.scope===null)?undefined:item.scope;if(scope!=undefined){item.handler.apply(scope,arguments)}else{item.handler(event)}}else{break}}}return this}else{throw new Error("invalid event passed to _dispatch")}},_parseEventName:function(eventName){var names=[];if(typeof eventName=="string"){names=eventName.split(" ")}return names}});var pkg=rad.getPackage("event");pkg.CollectionEvent=rad.event.Event.extend({_className:"CollectionEvent",name:"Collection",ADD:"add",REMOVE:"remove",UPDATE:"update",SORTED:"sort",RESET:"reset",REPLACE:"replace",item:null,index:null,init:function(type,i,m){this._super(type);console.log("creating collection event:",type,i,m);this.index=i;this.item=m}});var pkg=rad.getPackage("event");pkg.ChangeEvent=pkg.Event.extend({_className:"ChangeEvent",name:"Change",data:null,init:function(data){this._super();this.data=data}});var pkg=rad.getPackage("event");pkg.PropertyChangeEvent=pkg.Event.extend({_className:"PropertyChangeEvent",name:"PropertyChange",newValue:undefined,oldValue:undefined,init:function(type,newValue,oldValue){this._super(type);this.newValue=newValue;this.oldValue=oldValue}});var pkg=rad.getPackage("model");pkg.Model=rad.event.EventDispatcher.extend({_className:"Model",name:"Model",_data:null,init:function(name,defaults){this._data=defaults||{};this.name=name;this._super()},set:function(key,value){var tv=this._data[key];if(tv!=value){this._data[key]=value;this._dispatch(new rad.event.PropertyChangeEvent(key,value,tv));this._dispatch(new rad.event.ChangeEvent(this))}},get:function(key){return this._data[key]},reset:function(){this._data={}}});var pkg=rad.getPackage("model");pkg.CachableModel=pkg.Model.extend({_className:"CachableModel",name:"CachableModel",_expiration:null,_modified:new Date().getTime(),_defaults:{},init:function(name,expiration){this._super(name);this._cacheKey=this.name+"-"+this._className;this._restore()},set:function(key,value){this._super(key,value);localStorage.setItem(this._cacheKey+"-"+key,JSON.stringify(value));this._modified=new Date().getTime()},get:function(key){var tv=this._super(key);if(tv==undefined){tv=JSON.parse(localStorage.getItem(this._cacheKey+"-"+key));this[key]=tv}return tv},_restore:function(defaults){for(var i in this._defaults){this.set(i,this.get(i))}},reset:function(){this._super();this._restore()}});var pkg=rad.getPackage("collection");pkg.Collection=rad.event.EventDispatcher.extend({_className:"Collection",name:"Collection",_debug:true,data:[],sorts:[],_sortInterval:null,_key:null,_table:{},init:function(d,key){this._super();if(typeof key=="string"){this._key=key}this.sorts=[];this.autoSort=false;this._table={};if(d!==null&&d!==undefined&&d.push!==undefined){this.data=d.slice(0);if(this._key!==null){this._rebuildTable()}}else{this.data=[]}},addItem:function(item,unique){if(unique==true){if(this._key!==null){if(this._table[item[this._key]]!==undefined){this.log("keyed item already exists!!",item," returning index:",this._table[item[this._key]]);return this._table[item[this._key]]}}else{for(var i=0;i<this.getLength();i++){if(this.getItemAt(i)==item){return i}}}}this.data.push(item);if(this._key!==null){this.log("adding item:",this._key,item[this._key]);this._table[item[this._key]]=this.data.length-1}this._dispatchChange("add",item,this.data.length-1);if(item instanceof rad.model.Model){item.removeListener("Change",this._onItemChanged,this);item.addListener("Change",this._onItemChanged,this)}return this.data.length-1},removeItem:function(item){var id=this.indexOf(item);if(id!=-1){this.log(this,"found an item to remove at index:",id);if(item instanceof rad.model.Model){item.removeListener("Change",this._onItemChanged,this)}this.removeItemAt(id)}else{this.log("no item to remove:",item)}},removeItemAt:function(index){var item=this.data[index];if(item!==undefined){if(this._key!==null){this._table[item[this._key]]=undefined}if(item instanceof rad.model.Model){item.removeListener("Change",this._onItemChanged,this)}this.data.splice(index,1);if(this._key!==null){this._rebuildTable()}this._dispatchChange("remove",item,index)}},getItem:function(item){return this.getItemAt(this.indexOf(item))},getItemAt:function(index){return this.data[index]},removeAll:function(){for(var i=0;i<this.data.length;i++){var item=this.data[i];if(item instanceof rad.model.Model){item.removeListener("Change",this._onItemChanged,this)}}this.data=[];this._table={};this._dispatchChange("reset")},setItemAt:function(item,index){this.log("setItemAt called:",item,index);this.data[index]=item;if(this._key!==null){this._table[item[this._key]]=index}this._dispatchChange(this.UPDATE,item,index)},toArray:function(){return this.data},setCollection:function(a,key){this.log("setCollection called!",a,key);if(key!==undefined){this._key=key;this._table={}}for(var i=0;i<this.data.length;i++){var item=this.data[i];if(item instanceof rad.model.Model){item.removeListener("Change",this._onItemChanged,this)}}this.data=a;for(var j=0;j<this.data.length;j++){var item=this.data[j];if(item instanceof rad.model.Model){item.addListener("Change",this._onItemChanged,this)}}if(this._key!==undefined){this._rebuildTable()}this._dispatchChange(this.RESET)},contains:function(item){this.log("checking for item:",item);if(this._key!==null&&item!==null&&item!==undefined){this.log("using _table and key:",item[this._key]);return this._table[item[this._key]]!==undefined?this._table[item[this._key]]>-1:false}return(this.data.indexOf(item)>-1)},indexOf:function(item){if(this._key!==null&&item!==null&&item!==undefined){var r=this._table[item[this._key]]!==undefined?this._table[item[this._key]]:-1;this.log("indexOf using table and key:",r,item[this._key]);return r}return this.data.indexOf(item)},getLength:function(){return this.data.length},refresh:function(){},clone:function(){return new rad.collection.Collection(this.data.slice(0),this._key)},each:function(fn,scope){for(var i=0;i<this.getLength();i++){if(scope!==undefined&&scope!==null){fn.apply(scope,this.getItemAt(i))}else{fn(this.getItemAt(i))}}},addSortFunction:function(f,priority){if(priority!==undefined){this.sorts.splice(priority,0,f)}else{this.sorts.push(f);priority=this.sorts.length-1}return priority},doSort:function(){clearTimeout(this._sortInterval);var t=this;var interval=this.getLength();if(this.getLength()>1000){interval=1000}this._sortInterval=setTimeout(function(){t._doSort()},interval)},_doSort:function(){this.log("actually sorting!");clearInterval(this._sortInterval);var d=this.data.slice(0);if(this.sorts.length>0){for(var i=0;i<this.sorts.length;i++){this.data.sort(this.sorts[i])}}else{this.log("no sort function provided. returning.");return}if(d!==this.data){if(this._key!==null){this._rebuildTable()}this._dispatchChange(this.SORTED,null,null)}else{}},removeSortFunction:function(sortID){this.sorts.splice(sortID,1)},_rebuildTable:function(){this._table={};var a=0;var len=this.data.length;var start=new Date().getTime();for(a=0;a<len;a++){this._table[this.data[a][this._key]]=a}var eTime=new Date().getTime()-start;this.log("it took:",eTime,"ms to rebuild the table:",len)},_onItemChanged:function(event){this.log("_onItemChanged",event);this._dispatchChange("update",event.data,this.indexOf(event.data))},_dispatchChange:function(kind,item,index){this.log("dispatching a change!",kind,item,index);var cEvent=new rad.event.CollectionEvent(kind,index,item);this.log("event is ready:",cEvent);this._dispatch(cEvent);if(this.autoSort==true&&kind!="update"&&kind!="sorted"){this.doSort()}},destroy:function(){this.removeAll();this._super()}});var pkg=rad.getPackage("collection");pkg.FilteredCollection=pkg.Collection.extend({_className:"FilteredCollection",name:"FilteredCollection",_debug:false,expression:true,filterFunction:function(item){return this.expression},dp:null,_model:{},init:function(dp,filterMap,model){if(dp instanceof rad.collection.Collection){this._super([],dp._key);this.dp=dp;this._key=this.dp._key;this.dp.addListener("Collection.add",this._onTargetAdd,this);this.dp.addListener("Collection.remove",this._onTargetRemove,this);this.dp.addListener("Collection.update",this._onTargetUpdate,this);this.dp.addListener("Collection.reset",this._onTargetReset,this)}else{this.error("dataProvider supplied is not an ArrayCollection : ",arguments);return}this._model=(model)||{};this.setFilter(filterMap)},setFilter:function(filterMap){var shouldFilter=false;var isModel=(this._model.constructor==rad.model.Model);this.log("isModel?",isModel);if(typeof filterMap=="function"){this.filterFunction=filterMap;shouldFilter=true}else{if(typeof filterMap=="string"){this.filterFunction=function(item){if((String(item).indexOf(filterMap)>-1)||filterMap=="*"){return true}return false};shouldFilter=true}else{if(typeof filterMap=="object"){this._expression="";shouldFilter=true;for(var i in filterMap){if(filterMap[i] instanceof RegExp){if(isModel){this._expression+=" item.get('"+i+"').match("+filterMap[i]+") &&"}else{this._expression+=" item."+i+".match("+filterMap[i]+") &&"}}else{if(typeof filterMap[i]=="string"){if(isModel){this._expression+="(item.get('"+i+"') !== undefined ) && (item.get('"+i+"') !== null) && ( item.get('"+i+"').indexOf( '"+filterMap[i]+"' ) > -1 ) &&"}else{this._expression+="(item."+i+" !== undefined ) && (item."+i+" !== null) && ( item."+i+".indexOf( '"+filterMap[i]+"' ) > -1 ) &&"}}else{if(typeof filterMap[i]=="number"||typeof filterMap[i]=="boolean"){if(isModel){this._expression+=" ( item.get('"+i+"') == "+filterMap[i]+" ) &&"}else{this._expression+=" ( item."+i+" == "+filterMap[i]+" ) &&"}}else{if(typeof filterMap[i]=="object"){}}}}}var sp=this._expression.substr(this._expression.lastIndexOf("&&")).trimRight();if(sp=="&&"){this._expression=this._expression.substr(0,this._expression.lastIndexOf("&&"))}this.filterFunction=function(item){if(item!==undefined){if(eval(this._expression)){return true}}else{this.error(this,"item is undefined??",item)}return false}}}}if(shouldFilter){for(var i=0;i<this.dp.data.length;i++){this._processItem(this.dp.data[i])}}},_processItem:function(item){this.log("processing an item:",item);if(this.filterFunction(item)){this.log("item passes filter. adding:",item,this.expression,this.filterFunction);this.addItem(item,true)}else{this.log("item does NOT pass filter:",item);this.removeItem(item)}},setItemAt:function(item,index){this.data[index]=item;if(this._key!==null){this._table[item[this._key]]=index}},_onTargetAdd:function(event){var newItem,existingIndex;newItem=event.item;existingIndex=this.indexOf(newItem);if(existingIndex==-1&&this.filterFunction(newItem)){this.addItem(newItem)}},_onTargetRemove:function(event){this.removeItem(event.item)},_onTargetUpdate:function(event){var newItem,existingItem;newItem=event.item;existingItem=this.getItem(newItem);if(this.filterFunction(newItem)){if(existingItem!==undefined){if(newItem!=existingItem){this.setItemAt(newItem,this.indexOf(existingItem))}}else{this.addItem(newItem,true)}}else{if(existingItem!==undefined){this.removeItem(existingItem)}}},_onTargetReset:function(event){var i,len,item;len=this.dp.getLength();item=event.item;this.removeAll();for(i=len-1;i>=0;i--){item=this.dp.getItemAt(i);if(this.filterFunction(item)){this.addItem(item,true)}}},_onItemChanged:function(event){if(this.filterFunction(event.data)){this.addItem(event.data,true)}else{this.removeItem(event.data)}this._dispatchChange(this.UPDATE)},clearFilter:function(){this._expression=true},destroy:function(){this.dp.addListener("Collection.add",this._onTargetAdd,this);this.dp.addListener("Collection.remove",this._onTargetRemove,this);this.dp.addListener("Collection.update",this._onTargetUpdate,this);this.dp.addListener("Collection.reset",this._onTargetReset,this);this._super()}});var pkg=rad.getPackage("factory");pkg.Factory=rad.core.RadClass.extend({className:"Factory",name:"Factory",_debug:true,_product:null,_key:null,_products:null,init:function(product,key){this._product=(product instanceof rad.core.RadClass)?product:Object;this._key=key||null;this._products=new rad.collection.Collection([],this._key);this._super()},get:function(id){var oKey={};oKey[this._key]=id;var instance=this._products.getItem(oKey);if(instance===undefined){instance=new this._product(id);this._products.addItem(instance)}return instance}})})(window,undefined);